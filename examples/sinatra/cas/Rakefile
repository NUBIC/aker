desc 'Launch everything for the CAS example'
task :launch do
  processes = []

  Dir.chdir('..') do
    unless ENV['CAS_BASE']
      processes << fork { sh "bundle exec rackup cas/rubycas_server.ru" }
      ENV['CAS_BASE'] = 'http://localhost:9697'
    else
      $stderr.puts "Using existing CAS server #{ENV['CAS_BASE']}"
    end
    processes << fork { sh "bundle exec rackup cas/fortune_server.ru" }
    processes << fork { ruby "-rubygems cas/cas_proxy_callback.rb" }
    processes << fork { ruby "-rubygems cas/fortune_client.rb" }
  end

  trap('INT') { Process.kill('TERM', *processes) }

  Process.waitall
end

desc 'Reset CAS server state'
task :clean do
  rm_rf Dir['var/*']
end

task :default => :launch
